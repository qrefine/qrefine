from __future__ import absolute_import
import os
from qrefine.tests.unit import run_tests
from ase import Atoms
import warnings
from libtbx.test_utils import approx_equal


def run(prefix):
    """
    Exercise TensorMol calculator works together with Q|R.
    """

    tm = TensormolCalculator()
    energy, gradient = tm.run_qr(tm.atoms.mols[0])

    assert approx_equal(energy, -7.01911003671)
    assert approx_equal(gradient, [[54.72373444954559, 43.50211011650701, 55.0681687461352],
                                   [-110.79126231492444, 25.98146937078293, -11.155392610622426],
                                   [5.433491436770188, 6.52893640005011, 28.622889693640612],
                                   [-71.50338529045021, -3.6578466193136236, -14.458647838597882],
                                   [14.741859019844105, 13.126236850151095, 14.380723899173134],
                                   [-4.593095522329837, -6.852591886564875, -16.283703321909563],
                                   [70.52208042638348, -59.5259141945174, -20.292972622828866],
                                   [-56.19796768577346, 9.263974807632003, -51.28296067705901],
                                   [2.6644043343068895, -16.47976823726328, 14.091653049606416],
                                   [8.678765929867977, -11.392644499808615, -9.866803503526413],
                                   [-79.61664600629528, 37.13009889787888, -10.907654880253387],
                                   [128.39042327657435, -29.74868016959136, 41.756884083846124],
                                   [-15.024960893702614, 18.255828278610956, -14.611452494117255],
                                   [21.28006335078961, -0.2172458532869804, -25.080542379037084],
                                   [14.285160386794596, 4.564534513048582, -18.32772914956326],
                                   [2.439490468899258, 10.79255266315983, 26.174699521010446],
                                   [1.7264958417478928, 15.38243123306247, -42.04282200366032],
                                   [23.94582040213049, -28.693705758494268, 18.005391717834794],
                                   [-39.190252757996774, -23.244663074400655, 22.006558947672374],
                                   [-7.5440689820869435, -17.155966192899715, -22.01783573379451],
                                   [-14.229515476296564, 13.503061551269198, 17.968817012420786],
                                   [-42.692458567404834, 31.55037444695317, 62.63401289342725],
                                   [3.224648029245346, 17.928547580646576, -4.524288383451061],
                                   [-14.150630324115214, 1.2147768632076443, 1.967302103238517],
                                   [-11.589212064363652, -6.444221705381739, -4.77406901682601],
                                   [-5.5705251392947135, -49.58353381805122, 17.851453490207053],
                                   [12.42994083133531, -31.32628534955386, 0.5620932081847977],
                                   [-15.209140041336132, 2.6841055262949185, 18.113311015189275],
                                   [-38.73187194009035, -15.72274317196305, -11.82050674146153],
                                   [36.242545183467506, -10.805354680557413, -12.277902260267444],
                                   [15.232739148782514, -4.663316010381281, 8.999606560034826],
                                   [59.63334514038209, 26.088864339029772, 11.30765051583584],
                                   [15.608156356402093, 27.943937629842292, -43.96675247210592],
                                   [18.13331849770548, 7.431414655697998, 16.906001192291857],
                                   [17.86199385016078, -8.699557589383213, 33.00195465513993],
                                   [-10.848074631757044, 39.029932538400196, -25.227204796906726],
                                   [-39.85554941979901, 1.527429754721101, -19.432085940661143],
                                   [31.92966974414988, -30.73366946479253, -4.944928236082764],
                                   [3.6813964573627045, -4.724979244557905, -38.6569203686534],
                                   [14.529074495458673, 6.242069503845828, 12.534003126275708]], 0.001)


if(__name__ == "__main__"):
  tensormol_installed = False
  try:
    import TensorMol
    from qrefine.plugin.ase.tensormol_qr import TensormolCalculator
    tensormol_installed = True
  except ImportError:
    pass
  prefix = os.path.basename(__file__).replace(".py","")
  run_tests.runner(function=run, prefix=prefix, disable=not tensormol_installed)
