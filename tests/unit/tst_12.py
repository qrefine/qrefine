import os
import time
import iotbx
from iotbx import pdb
from libtbx import easy_run
from libtbx import easy_mp
import libtbx.load_env
import qrefine.finalise
import qrefine.charges
import qrefine.completion
from qrefine.utils import hierarchy_utils
import run_tests

### TODO: after this test works, split it into charge|completion|finalise

qr_repo_parent_env = 'QR_REPO_PARENT'
qr_repo_parent = os.environ.get(qr_repo_parent_env, None)

qrefine_d = libtbx.env.find_in_repositories("qrefine")
qr_unit_tests = os.path.join(qrefine_d, "tests", "unit")

pdbs = {'short_gap' : '''
CRYST1   51.603   51.675   51.797 109.94 108.48 110.02 P 1
ATOM    226  N   PRO C 207     -10.829 -35.831   9.195  1.00124.77           N
ATOM    227  CA  PRO C 207     -11.186 -35.424   7.855  1.00124.42           C
ATOM    228  C   PRO C 207     -11.801 -34.003   7.810  1.00124.73           C
ATOM    229  O   PRO C 207     -12.049 -33.286   8.754  1.00125.06           O
ATOM    230  CB  PRO C 207     -12.112 -36.562   7.372  1.00125.20           C
ATOM    231  CG  PRO C 207     -11.872 -37.718   8.356  1.00124.08           C
ATOM    232  CD  PRO C 207     -11.571 -36.989   9.669  1.00123.67           C
ATOM    233  HA  PRO C 207     -10.303 -35.352   7.219  1.00124.42           H
ATOM    234  HB2 PRO C 207     -11.901 -36.842   6.346  1.00125.20           H
ATOM    235  HB3 PRO C 207     -13.152 -36.260   7.440  1.00125.20           H
ATOM    236  HG2 PRO C 207     -12.730 -38.383   8.440  1.00124.08           H
ATOM    237  HG3 PRO C 207     -11.001 -38.294   8.057  1.00124.08           H
ATOM    238  HD2 PRO C 207     -12.502 -36.717  10.174  1.00123.67           H
ATOM    239  HD3 PRO C 207     -10.981 -37.609  10.338  1.00123.67           H
ATOM    240  N   ALA C 209     -10.757 -31.248   7.623  1.00125.69           N
ATOM    241  CA  ALA C 209      -9.949 -30.019   7.806  1.00126.45           C
ATOM    242  C   ALA C 209      -9.275 -29.348   6.549  1.00127.74           C
ATOM    243  O   ALA C 209      -8.711 -30.026   5.675  1.00128.11           O
ATOM    244  CB  ALA C 209      -8.818 -30.423   8.739  1.00126.59           C
ATOM    245  H   ALA C 209     -10.224 -32.033   7.246  1.00125.69           H
ATOM    246  HA  ALA C 209     -10.596 -29.300   8.295  1.00126.45           H
ATOM    247  HB1 ALA C 209      -8.240 -29.551   9.011  1.00126.59           H
ATOM    248  HB2 ALA C 209      -9.207 -30.906   9.629  1.00126.59           H
ATOM    249  HB3 ALA C 209      -8.172 -31.125   8.219  1.00126.59           H
''',
  "PRO_terminal" : """
CRYST1   42.664   49.718   66.065 109.25  94.96  99.24 P 1           4
ATOM    874  N   PRO A 115      -9.167  -7.159   4.783  1.00 30.39           N
ATOM    875  CA  PRO A 115      -9.350  -8.630   5.081  1.00 30.17           C
ATOM    876  C   PRO A 115      -9.382  -9.587   3.862  1.00 32.77           C
ATOM    877  O   PRO A 115     -10.069  -9.304   2.880  1.00 33.78           O
ATOM    878  CB  PRO A 115     -10.669  -8.662   5.838  1.00 28.12           C
ATOM    879  CG  PRO A 115     -10.665  -7.351   6.592  1.00 29.06           C
ATOM    880  CD  PRO A 115     -10.013  -6.329   5.660  1.00 30.28           C
ATOM    881  N  AGLY A 116      -8.745 -10.760   4.020  0.50 31.15           N
ATOM    882  CA AGLY A 116      -8.770 -11.833   3.012  0.50 27.99           C
ATOM    883  C  AGLY A 116      -7.959 -13.081   3.370  0.50 26.73           C
ATOM    884  O  AGLY A 116      -7.545 -13.840   2.487  0.50 26.23           O
ATOM    885  N  BGLY A 116      -8.621 -10.686   3.937  0.50 35.25           N
ATOM    886  CA BGLY A 116      -8.079 -11.393   2.744  0.50 36.56           C
ATOM    887  C  BGLY A 116      -8.989 -12.091   1.734  0.50 36.99           C
ATOM    888  O  BGLY A 116      -9.994 -11.547   1.293  0.50 37.57           O
ATOM    889  N  AGLY A 117      -7.748 -13.313   4.661  0.50 25.75           N
ATOM    890  CA AGLY A 117      -6.947 -14.457   5.099  0.50 24.75           C
ATOM    891  C  AGLY A 117      -5.660 -14.520   4.307  0.50 24.36           C
ATOM    892  O  AGLY A 117      -5.284 -13.541   3.660  0.50 23.17           O
ATOM    893  N  BGLY A 117      -8.582 -13.285   1.315  0.50 36.89           N
ATOM    894  CA BGLY A 117      -9.277 -14.011   0.264  0.50 35.40           C
ATOM    895  C  BGLY A 117      -8.318 -14.993  -0.358  0.50 37.53           C
ATOM    896  O  BGLY A 117      -8.109 -14.988  -1.568  0.50 39.46           O
ATOM    897  N  ASER A 118      -4.970 -15.660   4.366  0.50 25.06           N
ATOM    898  CA ASER A 118      -3.753 -15.855   3.578  0.50 25.99           C
ATOM    899  C  ASER A 118      -3.903 -15.046   2.311  0.50 28.77           C
ATOM    900  O  ASER A 118      -4.893 -15.203   1.584  0.50 30.82           O
ATOM    901  CB ASER A 118      -3.569 -17.326   3.226  0.50 24.41           C
ATOM    902  OG ASER A 118      -4.540 -17.742   2.278  0.50 25.05           O
ATOM    903  N  BSER A 118      -7.724 -15.839   0.481  0.50 38.64           N
ATOM    904  CA BSER A 118      -6.635 -16.713   0.055  0.50 38.40           C
ATOM    905  C  BSER A 118      -5.353 -15.909  -0.093  0.50 39.49           C
ATOM    906  O  BSER A 118      -4.263 -16.472  -0.176  0.50 39.26           O
ATOM    907  CB BSER A 118      -6.980 -17.441  -1.256  0.50 37.71           C
ATOM    908  OG BSER A 118      -8.020 -16.788  -1.972  0.50 34.61           O
""",
  'GLY_terminal' : '''
CRYST1   16.614   15.265   16.902  90.00  90.00  90.00 P 1
HETATM    1  N   GLY A   1      -2.476  -2.684  -3.356  1.00 20.00      A    N+1
HETATM    5  CA  GLY A   1      -2.620  -1.390  -2.713  1.00 20.00      A    C
HETATM    8  C   GLY A   1      -1.777  -1.333  -1.440  1.00 20.00      A    C
HETATM    9  O   GLY A   1      -1.349  -2.331  -0.968  1.00 20.00      A    O
HETATM   10  N   ALA A   2      -1.518  -0.057  -0.799  1.00 20.00      A    N
HETATM   12  CA  ALA A   2      -0.808  -0.011   0.467  1.00 20.00      A    C
HETATM   14  CB  ALA A   2      -1.723   0.085   1.686  1.00 20.00      A    C
HETATM   18  C   ALA A   2       0.356   0.977   0.488  1.00 20.00      A    C
HETATM   19  O   ALA A   2       0.271   2.005  -0.094  1.00 20.00      A    O
HETATM   20  N   ALA A   3       1.566   0.657   1.223  1.00 20.00      A    N
HETATM   22  CA  ALA A   3       2.684   1.584   1.220  1.00 20.00      A    C
HETATM   24  CB  ALA A   3       3.994   0.806   1.318  1.00 20.00      A    C
HETATM   28  C   ALA A   3       2.525   2.581   2.367  1.00 20.00      A    C
HETATM   29  O   ALA A   3       2.383   2.166   3.546  1.00 20.00      A    O
''',
  'helix' : """
CRYST1   16.291   18.744   30.715  90.00  90.00  90.00 P 1
SCALE1      0.061384  0.000000  0.000000        0.00000
SCALE2      0.000000  0.053350  0.000000        0.00000
SCALE3      0.000000  0.000000  0.032557        0.00000
ATOM      1  N   GLY A  87       6.046  11.922   5.000  1.00 80.00           N
ATOM      2  CA  GLY A  87       6.777  11.037   5.889  1.00 80.00           C
ATOM      3  C   GLY A  87       7.208  11.727   7.197  1.00 80.00           C
ATOM      4  O   GLY A  87       7.552  11.016   8.143  1.00 80.00           O
ATOM      5  HA2 GLY A  87       6.151  10.181   6.142  1.00 80.00           H
ATOM      6  HA3 GLY A  87       7.670  10.673   5.382  1.00 80.00           H
ATOM      7  HT1 GLY A  87       5.481  11.402   4.424  1.00 80.00           H
ATOM      8  HT2 GLY A  87       6.362  12.695   4.526  1.00 80.00           H
ATOM      9  N   GLY A  88       7.248  13.042   7.248  1.00 80.00           N
ATOM     10  CA  GLY A  88       7.861  13.744   8.387  1.00 80.00           C
ATOM     11  C   GLY A  88       7.082  13.437   9.673  1.00 80.00           C
ATOM     12  O   GLY A  88       7.692  13.174  10.712  1.00 80.00           O
ATOM     13  H   GLY A  88       6.872  13.660   6.529  1.00 80.00           H
ATOM     14  HA2 GLY A  88       8.894  13.419   8.512  1.00 80.00           H
ATOM     15  HA3 GLY A  88       7.847  14.820   8.212  1.00 80.00           H
ATOM     16  N   GLY A  89       5.753  13.529   9.640  1.00 80.00           N
ATOM     17  CA  GLY A  89       5.000  13.335  10.878  1.00 80.00           C
ATOM     18  C   GLY A  89       5.204  11.952  11.421  1.00 80.00           C
ATOM     19  O   GLY A  89       5.421  11.767  12.629  1.00 80.00           O
ATOM     20  H   GLY A  89       5.191  13.727   8.812  1.00 80.00           H
ATOM     21  HA2 GLY A  89       5.328  14.057  11.626  1.00 80.00           H
ATOM     22  HA3 GLY A  89       3.937  13.484  10.690  1.00 80.00           H
ATOM     23  N   GLY A  90       5.138  10.940  10.551  1.00 80.00           N
ATOM     24  CA  GLY A  90       5.317   9.584  11.016  1.00 80.00           C
ATOM     25  C   GLY A  90       6.702   9.325  11.564  1.00 80.00           C
ATOM     26  O   GLY A  90       6.869   8.577  12.510  1.00 80.00           O
ATOM     27  H   GLY A  90       4.967  11.033   9.550  1.00 80.00           H
ATOM     28  HA2 GLY A  90       4.592   9.374  11.802  1.00 80.00           H
ATOM     29  HA3 GLY A  90       5.140   8.893  10.192  1.00 80.00           H
ATOM     30  N   GLY A  91       7.717   9.953  10.967  1.00 80.00           N
ATOM     31  CA  GLY A  91       9.078   9.825  11.482  1.00 80.00           C
ATOM     32  C   GLY A  91       9.167  10.416  12.883  1.00 80.00           C
ATOM     33  O   GLY A  91       9.768   9.836  13.795  1.00 80.00           O
ATOM     34  H   GLY A  91       7.631  10.546  10.141  1.00 80.00           H
ATOM     35  HA2 GLY A  91       9.362   8.774  11.523  1.00 80.00           H
ATOM     36  HA3 GLY A  91       9.773  10.354  10.830  1.00 80.00           H
ATOM     37  N   GLY A  92       8.569  11.589  13.066  1.00 80.00           N
ATOM     38  CA  GLY A  92       8.571  12.212  14.379  1.00 80.00           C
ATOM     39  C   GLY A  92       7.807  11.339  15.374  1.00 80.00           C
ATOM     40  O   GLY A  92       8.274  11.127  16.495  1.00 80.00           O
ATOM     41  H   GLY A  92       8.086  12.120  12.341  1.00 80.00           H
ATOM     42  HA2 GLY A  92       9.595  12.336  14.730  1.00 80.00           H
ATOM     43  HA3 GLY A  92       8.094  13.191  14.327  1.00 80.00           H
ATOM     44  N   GLY A  93       6.648  10.831  14.954  1.00 80.00           N
ATOM     45  CA  GLY A  93       5.852  10.007  15.846  1.00 80.00           C
ATOM     46  C   GLY A  93       6.543   8.707  16.220  1.00 80.00           C
ATOM     47  O   GLY A  93       6.368   8.241  17.352  1.00 80.00           O
ATOM     48  H   GLY A  93       6.247  10.970  14.026  1.00 80.00           H
ATOM     49  HA2 GLY A  93       5.644  10.561  16.761  1.00 80.00           H
ATOM     50  HA3 GLY A  93       4.903   9.766  15.366  1.00 80.00           H
ATOM     51  N   GLY A  94       7.316   8.108  15.306  1.00 80.00           N
ATOM     52  CA  GLY A  94       8.069   6.911  15.672  1.00 80.00           C
ATOM     53  C   GLY A  94       9.095   7.229  16.749  1.00 80.00           C
ATOM     54  O   GLY A  94       9.242   6.502  17.717  1.00 80.00           O
ATOM     55  H   GLY A  94       7.436   8.416  14.341  1.00 80.00           H
ATOM     56  HA2 GLY A  94       7.389   6.147  16.049  1.00 80.00           H
ATOM     57  HA3 GLY A  94       8.588   6.519  14.797  1.00 80.00           H
ATOM     58  N   GLY A  95       9.799   8.362  16.572  1.00 80.00           N
ATOM     59  CA  GLY A  95      10.718   8.799  17.602  1.00 80.00           C
ATOM     60  C   GLY A  95       9.986   9.053  18.925  1.00 80.00           C
ATOM     61  O   GLY A  95      10.478   8.633  19.982  1.00 80.00           O
ATOM     62  H   GLY A  95       9.748   8.967  15.753  1.00 80.00           H
ATOM     63  HA2 GLY A  95      11.479   8.036  17.764  1.00 80.00           H
ATOM     64  HA3 GLY A  95      11.208   9.721  17.290  1.00 80.00           H
ATOM     65  N   GLY A  96       8.848   9.743  18.892  1.00 80.00           N
ATOM     66  CA  GLY A  96       8.100   9.974  20.115  1.00 80.00           C
ATOM     67  C   GLY A  96       7.693   8.670  20.785  1.00 80.00           C
ATOM     68  O   GLY A  96       7.804   8.505  21.994  1.00 80.00           O
ATOM     69  H   GLY A  96       8.430  10.144  18.053  1.00 80.00           H
ATOM     70  HA2 GLY A  96       8.710  10.548  20.813  1.00 80.00           H
ATOM     71  HA3 GLY A  96       7.199  10.545  19.890  1.00 80.00           H
ATOM     72  N   GLY A  97       7.185   7.734  19.986  1.00 80.00           N
ATOM     73  CA  GLY A  97       6.758   6.466  20.521  1.00 80.00           C
ATOM     74  C   GLY A  97       7.928   5.704  21.152  1.00 80.00           C
ATOM     75  O   GLY A  97       7.822   5.143  22.238  1.00 80.00           O
ATOM     76  H   GLY A  97       7.062   7.832  18.978  1.00 80.00           H
ATOM     77  HA2 GLY A  97       5.995   6.627  21.282  1.00 80.00           H
ATOM     78  HA3 GLY A  97       6.333   5.856  19.724  1.00 80.00           H
ATOM     79  N   GLY A  98       9.077   5.703  20.473  1.00 80.00           N
ATOM     80  CA  GLY A  98      10.259   5.038  20.999  1.00 80.00           C
ATOM     81  C   GLY A  98      10.776   5.677  22.259  1.00 80.00           C
ATOM     82  O   GLY A  98      11.190   5.000  23.207  1.00 80.00           O
ATOM     83  H   GLY A  98       9.215   6.150  19.567  1.00 80.00           H
ATOM     84  HA2 GLY A  98      10.022   3.996  21.214  1.00 80.00           H
ATOM     85  HA3 GLY A  98      11.051   5.063  20.251  1.00 80.00           H
ATOM     86  N   GLY A  99      10.812   6.998  22.323  1.00 80.00           N
ATOM     87  CA  GLY A  99      11.291   7.723  23.477  1.00 80.00           C
ATOM     88  C   GLY A  99      10.302   7.784  24.656  1.00 80.00           C
ATOM     89  O   GLY A  99      10.656   8.287  25.715  1.00 80.00           O
ATOM     90  OXT GLY A  99       9.077   7.282  24.507  1.00 80.00           O
ATOM     91  H   GLY A  99      10.505   7.607  21.565  1.00 80.00           H
ATOM     92  HA2 GLY A  99      12.210   7.256  23.832  1.00 80.00           H
ATOM     93  HA3 GLY A  99      11.525   8.746  23.181  1.00 80.00           H
ATOM     94  HXT GLY A  99       8.983   6.901  23.568  1.00 80.00           H
TER
END
""",
  'water' : '''
HETATM    1  O   HOH A   1      -0.210   0.000  -0.296  1.00 20.00      A    O
HETATM    2  H1  HOH A   1       0.733   0.000  -0.296  1.00 20.00      A    H
HETATM    3  H2  HOH A   1      -0.524   0.000   0.593  1.00 20.00      A    H
''',
  'pro' : '''
ATOM      1  N   PRO A   2     -25.598  25.222  75.213  1.00101.82           N
ATOM      2  CA  PRO A   2     -25.442  24.229  76.278  1.00101.04           C
ATOM      3  C   PRO A   2     -24.538  24.735  77.395  1.00102.01           C
ATOM      4  O   PRO A   2     -24.789  25.799  77.962  1.00106.79           O
ATOM      5  CB  PRO A   2     -24.800  23.031  75.558  1.00103.62           C
ATOM      6  CG  PRO A   2     -24.532  23.488  74.125  1.00 98.65           C
ATOM      7  CD  PRO A   2     -24.661  24.975  74.108  1.00 98.90           C
ATOM      8  H2  PRO A   2     -26.468  25.439  75.129  1.00101.82           H
ATOM      9  H3  PRO A   2     -25.124  25.959  75.418  1.00101.82           H
ATOM     10  HA  PRO A   2     -26.304  23.972  76.641  1.00101.04           H
ATOM     11  HB2 PRO A   2     -23.977  22.703  75.922  1.00103.62           H
ATOM     12  HB3 PRO A   2     -25.448  22.309  75.544  1.00103.62           H
ATOM     13  HG2 PRO A   2     -23.635  23.224  73.866  1.00 98.65           H
ATOM     14  HG3 PRO A   2     -25.186  23.086  73.532  1.00 98.65           H
ATOM     15  HD2 PRO A   2     -23.805  25.394  74.287  1.00 98.90           H
ATOM     16  HD3 PRO A   2     -25.039  25.275  73.267  1.00 98.90           H
''',
  'gly' : '''
ATOM      1  N   GLY A   1      -9.009   4.612   6.102  1.00 16.77           N
ATOM      2  CA  GLY A   1      -9.052   4.207   4.651  1.00 16.57           C
ATOM      3  C   GLY A   1      -8.015   3.140   4.419  1.00 16.16           C
ATOM      4  O   GLY A   1      -7.523   2.521   5.381  1.00 16.78           O
ATOM      5  H1  GLY A   1      -9.778   5.000   6.325  1.00 16.77           H
ATOM      6  H2  GLY A   1      -8.884   3.890   6.608  1.00 16.77           H
ATOM      7  H3  GLY A   1      -8.340   5.184   6.231  1.00 16.77           H
ATOM      8  HA2 GLY A   1      -9.928   3.856   4.426  1.00 16.57           H
ATOM      9  HA3 GLY A   1      -8.858   4.970   4.084  1.00 16.57           H
''',
  'c_terminal_capping' : '''
CRYST1   16.291   18.744   30.715  90.00  90.00  90.00 P 1
ATOM     65  N   GLY A  96       8.848   9.743  18.892  1.00 80.00           N
ATOM     66  CA  GLY A  96       8.100   9.974  20.115  1.00 80.00           C
ATOM     67  C   GLY A  96       7.693   8.670  20.785  1.00 80.00           C
ATOM     68  O   GLY A  96       7.804   8.505  21.994  1.00 80.00           O
ATOM     69  H   GLY A  96       8.430  10.144  18.053  1.00 80.00           H
ATOM     70  HA2 GLY A  96       8.710  10.548  20.813  1.00 80.00           H
ATOM     71  HA3 GLY A  96       7.199  10.545  19.890  1.00 80.00           H
ATOM     72  N   GLY A  97       7.185   7.734  19.986  1.00 80.00           N
ATOM     73  CA  GLY A  97       6.758   6.466  20.521  1.00 80.00           C
ATOM     74  C   GLY A  97       7.928   5.704  21.152  1.00 80.00           C
ATOM     75  O   GLY A  97       7.822   5.143  22.238  1.00 80.00           O
ATOM     76  H   GLY A  97       7.062   7.832  18.978  1.00 80.00           H
ATOM     77  HA2 GLY A  97       5.995   6.627  21.282  1.00 80.00           H
ATOM     78  HA3 GLY A  97       6.333   5.856  19.724  1.00 80.00           H
ATOM     79  N   GLY A  98       9.077   5.703  20.473  1.00 80.00           N
ATOM     80  CA  GLY A  98      10.259   5.038  20.999  1.00 80.00           C
ATOM     81  C   GLY A  98      10.776   5.677  22.259  1.00 80.00           C
ATOM     82  O   GLY A  98      11.190   5.000  23.207  1.00 80.00           O
ATOM     83  H   GLY A  98       9.215   6.150  19.567  1.00 80.00           H
ATOM     84  HA2 GLY A  98      10.022   3.996  21.214  1.00 80.00           H
ATOM     85  HA3 GLY A  98      11.051   5.063  20.251  1.00 80.00           H
ATOM     86  N   GLY A  99      10.812   6.998  22.323  1.00 80.00           N
ATOM     87  CA  GLY A  99      11.291   7.723  23.477  1.00 80.00           C
ATOM     88  C   GLY A  99      10.302   7.784  24.656  1.00 80.00           C
ATOM     89  O   GLY A  99      10.656   8.287  25.715  1.00 80.00           O
ATOM     90  OXT GLY A  99       9.077   7.282  24.507  1.00 80.00           O
ATOM     91  H   GLY A  99      10.505   7.607  21.565  1.00 80.00           H
ATOM     92  HA2 GLY A  99      12.210   7.256  23.832  1.00 80.00           H
ATOM     93  HA3 GLY A  99      11.525   8.746  23.181  1.00 80.00           H
ATOM     94  HXT GLY A  99       8.983   6.901  23.568  1.00 80.00           H
''',
  '2ona_short' : '''
CRYST1  114.000   56.292   72.397  90.00  90.00  90.00 P 1
SCALE1      0.008772  0.000000  0.000000        0.00000
SCALE2      0.000000  0.017764  0.000000        0.00000
SCALE3      0.000000  0.000000  0.013813        0.00000
ATOM    165  N   MET C   1      14.152   2.166  -0.478  1.00 15.83           N
ATOM    166  CA  MET C   1      15.414   1.757  -0.009  1.00 17.63           C
ATOM    167  C   MET C   1      15.735   2.284   1.263  1.00 16.04           C
ATOM    168  O   MET C   1      15.707   3.281   1.413  1.00 16.36           O
ATOM    169  CB  MET C   1      16.620   2.011  -1.087  1.00 18.45           C
ATOM    170  CG  MET C   1      16.159   1.909  -2.489  1.00 19.74           C
ATOM    171  SD  MET C   1      17.429   2.249  -3.647  1.00 23.51           S
ATOM    172  CE  MET C   1      18.248   0.458  -3.569  1.00 20.93           C
ATOM    173  H1  MET C   1      13.895   1.827  -1.399  0.00 15.83           H
ATOM    174  H2  MET C   1      13.445   1.937   0.155  0.00 15.83           H
ATOM    175  H3  MET C   1      14.143   3.214  -0.522  0.00 15.83           H
ATOM    176  HA  MET C   1      15.333   0.490  -0.011  0.00 17.63           H
ATOM    177  HB2 MET C   1      16.810   3.090  -0.817  0.00 18.45           H
ATOM    178  HB3 MET C   1      17.426   1.461  -0.916  0.00 18.45           H
ATOM    179  HG2 MET C   1      15.631   1.057  -2.711  0.00 19.74           H
ATOM    180  HG3 MET C   1      15.340   2.800  -2.721  0.00 19.74           H
ATOM    181  HE1 MET C   1      19.100   0.489  -3.948  0.00 20.93           H
ATOM    182  HE2 MET C   1      18.238   0.239  -2.466  0.00 20.93           H
ATOM    183  HE3 MET C   1      17.540  -0.167  -4.039  0.00 20.93           H
ATOM    184  N   VAL C   2      16.257   1.376   2.152  1.00 15.45           N
ATOM    185  CA  VAL C   2      16.718   1.803   3.523  1.00 13.04           C
ATOM    186  C   VAL C   2      17.869   1.072   3.958  1.00 13.01           C
ATOM    187  O   VAL C   2      17.993  -0.053   3.718  1.00 14.93           O
ATOM    188  CB  VAL C   2      15.419   1.470   4.437  1.00 13.15           C
ATOM    189  CG1 VAL C   2      15.836   1.829   5.758  1.00 14.23           C
ATOM    190  CG2 VAL C   2      14.183   2.221   3.883  1.00 10.68           C
ATOM    191  H   VAL C   2      16.309   0.427   2.022  0.00 15.45           H
ATOM    192  HA  VAL C   2      16.792   2.913   3.458  0.00 13.04           H
ATOM    193  HB  VAL C   2      15.364   0.400   4.385  0.00 13.15           H
ATOM    194 HG11 VAL C   2      14.883   1.588   6.649  0.00 14.23           H
ATOM    195 HG12 VAL C   2      16.739   1.495   6.255  0.00 14.23           H
ATOM    196 HG13 VAL C   2      15.814   3.066   5.872  0.00 14.23           H
ATOM    197 HG21 VAL C   2      13.371   1.925   4.711  0.00 10.68           H
ATOM    198 HG22 VAL C   2      14.338   3.199   3.993  0.00 10.68           H
ATOM    199 HG23 VAL C   2      13.911   1.843   3.055  0.00 10.68           H
ATOM    200  N   GLY C   3      18.880   1.891   4.469  1.00 12.47           N
ATOM    201  CA  GLY C   3      20.087   1.084   4.948  1.00 11.62           C
ATOM    202  C   GLY C   3      20.572   1.927   5.959  1.00 12.37           C
ATOM    203  O   GLY C   3      20.540   3.143   6.238  1.00 11.90           O
ATOM    204  H   GLY C   3      18.832   2.730   4.574  0.00 12.47           H
ATOM    205  HA2 GLY C   3      19.858   0.168   5.145  0.00 11.62           H
ATOM    206  HA3 GLY C   3      20.801   1.122   4.102  0.00 11.62           H
ATOM    207  N   GLY C   4      21.647   0.940   7.016  1.00 13.71           N
ATOM    208  CA  GLY C   4      22.303   1.777   8.031  1.00 12.70           C
ATOM    209  C   GLY C   4      23.367   1.000   8.506  1.00 13.38           C
ATOM    210  O   GLY C   4      23.465  -0.397   8.245  1.00 10.64           O
ATOM    211  H   GLY C   4      21.543   0.170   6.750  0.00 13.71           H
ATOM    212  HA2 GLY C   4      22.533   2.649   7.724  0.00 12.70           H
ATOM    213  HA3 GLY C   4      21.527   1.870   8.830  0.00 12.70           H
''',
  '10_capping' : '''
CRYST1  154.429  137.481   99.277  90.00  90.00  90.00 P 1
SCALE1      0.006475  0.000000  0.000000        0.00000
SCALE2      0.000000  0.007274  0.000000        0.00000
SCALE3      0.000000  0.000000  0.010073        0.00000
ATOM      1  N   TYR A   3     -22.500   2.456  -7.246  1.00 37.07           N
ATOM      2  CA  TYR A   3     -21.455   3.314  -6.714  1.00 35.87           C
ATOM      3  C   TYR A   3     -20.433   2.450  -5.990  1.00 41.95           C
ATOM      4  O   TYR A   3     -20.772   1.406  -5.426  1.00 38.46           O
ATOM      5  CB  TYR A   3     -22.025   4.370  -5.757  1.00 38.58           C
ATOM      6  CG  TYR A   3     -22.982   5.347  -6.406  1.00 39.55           C
ATOM      7  CD1 TYR A   3     -24.290   4.979  -6.699  1.00 41.94           C
ATOM      8  CD2 TYR A   3     -22.580   6.639  -6.720  1.00 34.06           C
ATOM      9  CE1 TYR A   3     -25.169   5.868  -7.291  1.00 38.46           C
ATOM     10  CE2 TYR A   3     -23.453   7.535  -7.312  1.00 48.32           C
ATOM     11  CZ  TYR A   3     -24.746   7.144  -7.595  1.00 44.96           C
ATOM     12  OH  TYR A   3     -25.617   8.033  -8.183  1.00 42.07           O
ATOM     13  H   TYR A   3     -22.938   2.038  -6.635  0.00 37.07           H
ATOM         H2  TYR A   3     -23.089   2.953  -7.711  1.00 37.07           H
ATOM     14  HA  TYR A   3     -21.009   3.771  -7.444  0.00 35.87           H
ATOM     15  HB2 TYR A   3     -22.503   3.918  -5.045  0.00 38.58           H
ATOM     16  HB3 TYR A   3     -21.290   4.881  -5.384  0.00 38.58           H
ATOM     17  HD1 TYR A   3     -24.579   4.119  -6.496  0.00 41.94           H
ATOM     18  HD2 TYR A   3     -21.709   6.906  -6.531  0.00 34.06           H
ATOM     19  HE1 TYR A   3     -26.041   5.606  -7.482  0.00 38.46           H
ATOM     20  HE2 TYR A   3     -23.170   8.397  -7.518  0.00 48.32           H
ATOM     21  HH  TYR A   3     -25.233   8.769  -8.313  0.00 42.07           H
ATOM     22  N   LYS A   4     -19.175   2.881  -6.016  1.00 35.22           N
ATOM     23  CA  LYS A   4     -18.097   2.126  -5.399  1.00 48.26           C
ATOM     24  C   LYS A   4     -17.469   2.927  -4.267  1.00 39.89           C
ATOM     25  O   LYS A   4     -17.386   4.157  -4.323  1.00 39.76           O
ATOM     26  CB  LYS A   4     -17.020   1.739  -6.423  1.00 53.77           C
ATOM     27  CG  LYS A   4     -16.130   0.590  -5.967  1.00 45.88           C
ATOM     28  CD  LYS A   4     -14.671   0.812  -6.325  1.00 49.13           C
ATOM     29  CE  LYS A   4     -14.494   1.117  -7.802  1.00 57.95           C
ATOM     30  NZ  LYS A   4     -13.234   0.520  -8.332  1.00 61.52           N
ATOM     31  H   LYS A   4     -18.921   3.613  -6.388  0.00 35.22           H
ATOM     32  HA  LYS A   4     -18.460   1.309  -5.023  0.00 48.26           H
ATOM     33  HB2 LYS A   4     -17.454   1.469  -7.247  0.00 53.77           H
ATOM     34  HB3 LYS A   4     -16.452   2.508  -6.586  0.00 53.77           H
ATOM     35  HG2 LYS A   4     -16.194   0.503  -5.003  0.00 45.88           H
ATOM     36  HG3 LYS A   4     -16.424  -0.229  -6.396  0.00 45.88           H
ATOM     37  HD2 LYS A   4     -14.328   1.564  -5.817  0.00 49.13           H
ATOM     38  HD3 LYS A   4     -14.166   0.010  -6.118  0.00 49.13           H
ATOM     39  HE2 LYS A   4     -15.240   0.744  -8.298  0.00 57.95           H
ATOM     40  HE3 LYS A   4     -14.452   2.078  -7.928  0.00 57.95           H
ATOM     41  HZ1 LYS A   4     -12.533   0.850  -7.893  0.00 61.52           H
ATOM     42  HZ2 LYS A   4     -13.250  -0.364  -8.230  0.00 61.52           H
ATOM     43  HZ3 LYS A   4     -13.148   0.709  -9.197  0.00 61.52           H
ATOM     44  N   LEU A   5     -17.031   2.212  -3.236  1.00 42.92           N
ATOM     45  CA  LEU A   5     -16.347   2.799  -2.093  1.00 38.86           C
ATOM     46  C   LEU A   5     -14.986   2.139  -1.947  1.00 35.64           C
ATOM     47  O   LEU A   5     -14.889   0.909  -1.942  1.00 44.75           O
ATOM     48  CB  LEU A   5     -17.166   2.625  -0.812  1.00 39.92           C
ATOM     49  CG  LEU A   5     -16.447   2.921   0.505  1.00 33.88           C
ATOM     50  CD1 LEU A   5     -16.023   4.381   0.586  1.00 42.69           C
ATOM     51  CD2 LEU A   5     -17.328   2.550   1.687  1.00 41.88           C
ATOM     52  H   LEU A   5     -17.122   1.359  -3.176  0.00 42.92           H
ATOM     53  HA  LEU A   5     -16.214   3.747  -2.247  0.00 38.86           H
ATOM     54  HB2 LEU A   5     -17.933   3.217  -0.860  0.00 39.92           H
ATOM     55  HB3 LEU A   5     -17.473   1.706  -0.771  0.00 39.92           H
ATOM     56  HG  LEU A   5     -15.645   2.377   0.552  0.00 33.88           H
ATOM     57 HD11 LEU A   5     -15.572   4.532   1.431  0.00 42.69           H
ATOM     58 HD12 LEU A   5     -15.422   4.576  -0.150  0.00 42.69           H
ATOM     59 HD13 LEU A   5     -16.812   4.942   0.527  0.00 42.69           H
ATOM     60 HD21 LEU A   5     -16.852   2.746   2.509  0.00 41.88           H
ATOM     61 HD22 LEU A   5     -18.146   3.070   1.646  0.00 41.88           H
ATOM     62 HD23 LEU A   5     -17.534   1.603   1.642  0.00 41.88           H
ATOM     63  N   ILE A   6     -13.941   2.951  -1.834  1.00 41.31           N
ATOM     64  CA  ILE A   6     -12.575   2.466  -1.677  1.00 37.61           C
ATOM     65  C   ILE A   6     -12.111   2.844  -0.278  1.00 41.41           C
ATOM     66  O   ILE A   6     -11.886   4.025   0.014  1.00 40.10           O
ATOM     67  CB  ILE A   6     -11.639   3.037  -2.749  1.00 36.28           C
ATOM     68  CG1 ILE A   6     -12.125   2.637  -4.144  1.00 43.61           C
ATOM     69  CG2 ILE A   6     -10.214   2.561  -2.519  1.00 41.35           C
ATOM     70  CD1 ILE A   6     -11.226   3.102  -5.264  1.00 38.07           C
ATOM     71  H   ILE A   6     -14.000   3.809  -1.846  0.00 41.31           H
ATOM     72  HA  ILE A   6     -12.567   1.499  -1.750  0.00 37.61           H
ATOM     73  HB  ILE A   6     -11.653   4.005  -2.685  0.00 36.28           H
ATOM     74 HG12 ILE A   6     -12.179   1.670  -4.190  0.00 43.61           H
ATOM     75 HG13 ILE A   6     -13.003   3.022  -4.290  0.00 43.61           H
ATOM     76 HG21 ILE A   6      -9.642   2.934  -3.208  0.00 41.35           H
ATOM     77 HG22 ILE A   6      -9.919   2.860  -1.645  0.00 41.35           H
ATOM     78 HG23 ILE A   6     -10.195   1.592  -2.561  0.00 41.35           H
ATOM     79 HD11 ILE A   6     -11.600   2.811  -6.110  0.00 38.07           H
ATOM     80 HD12 ILE A   6     -11.170   4.070  -5.242  0.00 38.07           H
ATOM     81 HD13 ILE A   6     -10.344   2.716  -5.141  0.00 38.07           H
ATOM         HC  ILE A   6     -11.985   2.135   0.416  1.00 41.41           H
ATOM     82  N   ALA A  23     -26.254   9.620  -5.654  1.00 39.10           N
ATOM     83  CA  ALA A  23     -25.023   9.673  -4.873  1.00 45.54           C
ATOM     84  C   ALA A  23     -25.283  10.077  -3.428  1.00 46.94           C
ATOM     85  O   ALA A  23     -24.519   9.696  -2.533  1.00 35.65           O
ATOM     86  CB  ALA A  23     -24.029  10.637  -5.523  1.00 29.92           C
ATOM     87  H   ALA A  23     -26.323  10.232  -6.254  0.00 39.10           H
ATOM         H2  ALA A  23     -26.305   8.829  -6.081  1.00 39.10           H
ATOM     88  HA  ALA A  23     -24.619   8.791  -4.866  0.00 45.54           H
ATOM     89  HB1 ALA A  23     -23.218  10.660  -4.991  0.00 29.92           H
ATOM     90  HB2 ALA A  23     -23.829  10.326  -6.420  0.00 29.92           H
ATOM     91  HB3 ALA A  23     -24.426  11.521  -5.560  0.00 29.92           H
ATOM         HC  ALA A  23     -26.071  10.650  -3.203  1.00 46.94           H
ATOM     92  N   ALA A  26     -26.131   6.711  -1.722  1.00 41.69           N
ATOM     93  CA  ALA A  26     -24.992   5.803  -1.638  1.00 31.40           C
ATOM     94  C   ALA A  26     -24.013   6.234  -0.555  1.00 34.74           C
ATOM     95  O   ALA A  26     -23.337   5.388   0.042  1.00 41.60           O
ATOM     96  CB  ALA A  26     -24.285   5.717  -2.990  1.00 27.76           C
ATOM     97  H   ALA A  26     -26.199   7.134  -2.468  0.00 41.69           H
ATOM         H2  ALA A  26     -26.894   6.246  -1.616  1.00 41.69           H
ATOM     98  HA  ALA A  26     -25.314   4.916  -1.413  0.00 31.40           H
ATOM     99  HB1 ALA A  26     -23.532   5.110  -2.914  0.00 27.76           H
ATOM    100  HB2 ALA A  26     -24.911   5.387  -3.653  0.00 27.76           H
ATOM    101  HB3 ALA A  26     -23.974   6.601  -3.240  0.00 27.76           H
ATOM    102  N   GLU A  27     -23.926   7.538  -0.286  1.00 35.94           N
ATOM    103  CA  GLU A  27     -23.023   8.026   0.752  1.00 36.81           C
ATOM    104  C   GLU A  27     -23.452   7.537   2.129  1.00 40.24           C
ATOM    105  O   GLU A  27     -22.637   7.001   2.888  1.00 34.11           O
ATOM    106  CB  GLU A  27     -22.960   9.554   0.717  1.00 32.28           C
ATOM    107  CG  GLU A  27     -22.009  10.156   1.739  1.00 38.25           C
ATOM    108  CD  GLU A  27     -21.979  11.673   1.692  1.00 37.78           C
ATOM    109  OE1 GLU A  27     -22.945  12.276   1.179  1.00 35.43           O
ATOM    110  OE2 GLU A  27     -20.988  12.263   2.172  1.00 47.01           O
ATOM    111  H   GLU A  27     -24.375   8.153  -0.686  0.00 35.94           H
ATOM    112  HA  GLU A  27     -22.131   7.686   0.579  0.00 36.81           H
ATOM    113  HB2 GLU A  27     -22.664   9.834  -0.163  0.00 32.28           H
ATOM    114  HB3 GLU A  27     -23.846   9.907   0.893  0.00 32.28           H
ATOM    115  HG2 GLU A  27     -22.290   9.889   2.628  0.00 38.25           H
ATOM    116  HG3 GLU A  27     -21.111   9.833   1.564  0.00 38.25           H
ATOM         HC  GLU A  27     -24.400   7.648   2.426  1.00 40.24           H
ATOM    117  N   PHE A  30     -22.573   4.055   2.526  1.00 43.75           N
ATOM    118  CA  PHE A  30     -21.134   3.915   2.719  1.00 39.51           C
ATOM    119  C   PHE A  30     -20.679   4.525   4.039  1.00 40.51           C
ATOM    120  O   PHE A  30     -19.736   4.019   4.658  1.00 37.72           O
ATOM    121  CB  PHE A  30     -20.386   4.547   1.546  1.00 40.95           C
ATOM    122  CG  PHE A  30     -20.512   3.776   0.263  1.00 40.15           C
ATOM    123  CD1 PHE A  30     -20.803   2.421   0.279  1.00 45.11           C
ATOM    124  CD2 PHE A  30     -20.338   4.403  -0.959  1.00 30.58           C
ATOM    125  CE1 PHE A  30     -20.919   1.707  -0.899  1.00 40.92           C
ATOM    126  CE2 PHE A  30     -20.453   3.695  -2.142  1.00 35.88           C
ATOM    127  CZ  PHE A  30     -20.744   2.344  -2.111  1.00 37.64           C
ATOM    128  H   PHE A  30     -22.799   4.617   1.916  0.00 43.75           H
ATOM         H2  PHE A  30     -22.923   3.260   2.291  1.00 43.75           H
ATOM    129  HA  PHE A  30     -20.912   2.971   2.738  0.00 39.51           H
ATOM    130  HB2 PHE A  30     -20.739   5.437   1.393  0.00 40.95           H
ATOM    131  HB3 PHE A  30     -19.443   4.601   1.769  0.00 40.95           H
ATOM    132  HD1 PHE A  30     -20.922   1.987   1.093  0.00 45.11           H
ATOM    133  HD2 PHE A  30     -20.142   5.312  -0.985  0.00 30.58           H
ATOM    134  HE1 PHE A  30     -21.115   0.798  -0.875  0.00 40.92           H
ATOM    135  HE2 PHE A  30     -20.334   4.127  -2.957  0.00 35.88           H
ATOM    136  HZ  PHE A  30     -20.822   1.866  -2.905  0.00 37.64           H
ATOM         HC  PHE A  30     -21.143   5.333   4.403  1.00 40.51           H
ATOM    137  N   TRP A  43     -13.245  11.811   3.551  1.00 37.74           N
ATOM    138  CA  TRP A  43     -13.991  11.284   2.419  1.00 41.36           C
ATOM    139  C   TRP A  43     -13.814  12.165   1.189  1.00 44.28           C
ATOM    140  O   TRP A  43     -13.556  13.366   1.293  1.00 40.92           O
ATOM    141  CB  TRP A  43     -15.476  11.158   2.763  1.00 38.08           C
ATOM    142  CG  TRP A  43     -15.749  10.130   3.819  1.00 40.95           C
ATOM    143  CD1 TRP A  43     -15.351  10.171   5.124  1.00 39.22           C
ATOM    144  CD2 TRP A  43     -16.473   8.905   3.659  1.00 35.52           C
ATOM    145  NE1 TRP A  43     -15.784   9.049   5.786  1.00 44.14           N
ATOM    146  CE2 TRP A  43     -16.477   8.255   4.909  1.00 36.64           C
ATOM    147  CE3 TRP A  43     -17.122   8.295   2.582  1.00 28.30           C
ATOM    148  CZ2 TRP A  43     -17.101   7.027   5.112  1.00 35.78           C
ATOM    149  CZ3 TRP A  43     -17.742   7.076   2.784  1.00 32.52           C
ATOM    150  CH2 TRP A  43     -17.727   6.455   4.039  1.00 37.47           C
ATOM    151  H   TRP A  43     -13.623  12.483   3.932  0.00 37.74           H
ATOM         H2  TRP A  43     -13.151  11.168   4.174  1.00 37.74           H
ATOM    152  HA  TRP A  43     -13.657  10.399   2.205  0.00 41.36           H
ATOM    153  HB2 TRP A  43     -15.798  12.013   3.088  0.00 38.08           H
ATOM    154  HB3 TRP A  43     -15.964  10.903   1.964  0.00 38.08           H
ATOM    155  HD1 TRP A  43     -14.857  10.859   5.509  0.00 39.22           H
ATOM    156  HE1 TRP A  43     -15.644   8.873   6.616  0.00 44.14           H
ATOM    157  HE3 TRP A  43     -17.136   8.701   1.745  0.00 28.30           H
ATOM    158  HZ2 TRP A  43     -17.093   6.613   5.945  0.00 35.78           H
ATOM    159  HZ3 TRP A  43     -18.176   6.661   2.074  0.00 32.52           H
ATOM    160  HH2 TRP A  43     -18.153   5.635   4.145  0.00 37.47           H
ATOM    161  N   CYS A  44     -13.948  11.544   0.019  1.00 43.55           N
ATOM    162  CA  CYS A  44     -13.878  12.244  -1.255  1.00 43.52           C
ATOM    163  C   CYS A  44     -14.755  11.508  -2.256  1.00 30.63           C
ATOM    164  O   CYS A  44     -14.828  10.276  -2.247  1.00 33.62           O
ATOM    165  CB  CYS A  44     -12.437  12.346  -1.775  1.00 42.78           C
ATOM    166  SG  CYS A  44     -12.212  13.498  -3.156  1.00 52.39           S
ATOM    167  H   CYS A  44     -14.083  10.698  -0.061  0.00 43.55           H
ATOM    168  HA  CYS A  44     -14.227  13.143  -1.147  0.00 43.52           H
ATOM    169  HB2 CYS A  44     -11.866  12.643  -1.049  0.00 42.78           H
ATOM    170  HB3 CYS A  44     -12.153  11.468  -2.075  0.00 42.78           H
ATOM         HG  CYS A  44     -11.302  13.857  -3.364  1.00 52.39           H
ATOM    171  N   TYR A  45     -15.425  12.272  -3.116  1.00 37.87           N
ATOM    172  CA  TYR A  45     -16.349  11.715  -4.094  1.00 35.01           C
ATOM    173  C   TYR A  45     -16.036  12.276  -5.473  1.00 39.01           C
ATOM    174  O   TYR A  45     -15.818  13.482  -5.623  1.00 40.51           O
ATOM    175  CB  TYR A  45     -17.803  12.019  -3.718  1.00 31.40           C
ATOM    176  CG  TYR A  45     -18.805  11.563  -4.755  1.00 39.51           C
ATOM    177  CD1 TYR A  45     -19.028  10.211  -4.984  1.00 32.44           C
ATOM    178  CD2 TYR A  45     -19.523  12.482  -5.508  1.00 28.96           C
ATOM    179  CE1 TYR A  45     -19.939   9.788  -5.931  1.00 29.90           C
ATOM    180  CE2 TYR A  45     -20.436  12.069  -6.457  1.00 28.60           C
ATOM    181  CZ  TYR A  45     -20.640  10.721  -6.664  1.00 34.71           C
ATOM    182  OH  TYR A  45     -21.549  10.302  -7.609  1.00 35.76           O
ATOM    183  H   TYR A  45     -15.359  13.129  -3.151  0.00 37.87           H
ATOM    184  HA  TYR A  45     -16.239  10.752  -4.126  0.00 35.01           H
ATOM    185  HB2 TYR A  45     -18.012  11.568  -2.885  0.00 31.40           H
ATOM    186  HB3 TYR A  45     -17.904  12.977  -3.608  0.00 31.40           H
ATOM    187  HD1 TYR A  45     -18.556   9.580  -4.490  0.00 32.44           H
ATOM    188  HD2 TYR A  45     -19.387  13.392  -5.370  0.00 28.96           H
ATOM    189  HE1 TYR A  45     -20.079   8.880  -6.073  0.00 29.90           H
ATOM    190  HE2 TYR A  45     -20.911  12.696  -6.954  0.00 28.60           H
ATOM    191  HH  TYR A  45     -21.904  10.966  -7.981  0.00 35.76           H
ATOM         HC  TYR A  45     -16.006  11.667  -6.266  1.00 39.01           H
ATOM    192  N   LYS A  50     -18.128   7.861  -9.871  1.00 32.32           N
ATOM    193  CA  LYS A  50     -19.082   7.313  -8.905  1.00 33.84           C
ATOM    194  C   LYS A  50     -18.373   6.544  -7.793  1.00 33.17           C
ATOM    195  O   LYS A  50     -18.860   5.516  -7.317  1.00 44.09           O
ATOM    196  CB  LYS A  50     -20.122   6.425  -9.596  1.00 43.61           C
ATOM    197  CG  LYS A  50     -21.365   7.162 -10.069  1.00 40.43           C
ATOM    198  CD  LYS A  50     -21.081   8.001 -11.301  1.00 45.18           C
ATOM    199  CE  LYS A  50     -22.245   8.923 -11.625  1.00 47.14           C
ATOM    200  NZ  LYS A  50     -21.932   9.810 -12.779  1.00 52.95           N
ATOM    201  H   LYS A  50     -18.196   8.712  -9.971  0.00 32.32           H
ATOM         H2  LYS A  50     -17.289   7.687  -9.596  1.00 32.32           H
ATOM    202  HA  LYS A  50     -19.558   8.050  -8.491  0.00 33.84           H
ATOM    203  HB2 LYS A  50     -19.711   6.013 -10.372  0.00 43.61           H
ATOM    204  HB3 LYS A  50     -20.406   5.738  -8.973  0.00 43.61           H
ATOM    205  HG2 LYS A  50     -22.054   6.517 -10.293  0.00 40.43           H
ATOM    206  HG3 LYS A  50     -21.675   7.752  -9.364  0.00 40.43           H
ATOM    207  HD2 LYS A  50     -20.295   8.547 -11.142  0.00 45.18           H
ATOM    208  HD3 LYS A  50     -20.936   7.416 -12.061  0.00 45.18           H
ATOM    209  HE2 LYS A  50     -23.022   8.389 -11.853  0.00 47.14           H
ATOM    210  HE3 LYS A  50     -22.435   9.481 -10.855  0.00 47.14           H
ATOM    211  HZ1 LYS A  50     -22.625  10.340 -12.951  0.00 52.95           H
ATOM    212  HZ2 LYS A  50     -21.222  10.313 -12.592  0.00 52.95           H
ATOM    213  HZ3 LYS A  50     -21.757   9.319 -13.501  0.00 52.95           H
ATOM    214  N   THR A  51     -17.215   7.044  -7.368  1.00 30.84           N
ATOM    215  CA  THR A  51     -16.377   6.361  -6.390  1.00 36.44           C
ATOM    216  C   THR A  51     -16.208   7.237  -5.157  1.00 36.67           C
ATOM    217  O   THR A  51     -15.687   8.354  -5.251  1.00 37.75           O
ATOM    218  CB  THR A  51     -15.010   6.009  -6.984  1.00 35.10           C
ATOM    219  OG1 THR A  51     -15.182   5.094  -8.073  1.00 42.34           O
ATOM    220  CG2 THR A  51     -14.121   5.367  -5.930  1.00 31.89           C
ATOM    221  H   THR A  51     -16.888   7.792  -7.638  0.00 30.84           H
ATOM    222  HA  THR A  51     -16.811   5.537  -6.119  0.00 36.44           H
ATOM    223  HB  THR A  51     -14.577   6.816  -7.303  0.00 35.10           H
ATOM    224  HG1 THR A  51     -15.660   5.443  -8.669  0.00 42.34           H
ATOM    225 HG21 THR A  51     -13.258   5.147  -6.314  0.00 31.89           H
ATOM    226 HG22 THR A  51     -13.990   5.980  -5.189  0.00 31.89           H
ATOM    227 HG23 THR A  51     -14.534   4.555  -5.598  0.00 31.89           H
ATOM    228  N   PHE A  52     -16.650   6.730  -4.010  1.00 31.54           N
ATOM    229  CA  PHE A  52     -16.346   7.336  -2.722  1.00 35.62           C
ATOM    230  C   PHE A  52     -15.027   6.768  -2.213  1.00 33.38           C
ATOM    231  O   PHE A  52     -14.811   5.554  -2.262  1.00 34.00           O
ATOM    232  CB  PHE A  52     -17.457   7.060  -1.707  1.00 33.36           C
ATOM    233  CG  PHE A  52     -18.762   7.732  -2.025  1.00 33.81           C
ATOM    234  CD1 PHE A  52     -19.653   7.162  -2.919  1.00 37.43           C
ATOM    235  CD2 PHE A  52     -19.107   8.926  -1.412  1.00 21.66           C
ATOM    236  CE1 PHE A  52     -20.858   7.775  -3.205  1.00 31.13           C
ATOM    237  CE2 PHE A  52     -20.308   9.543  -1.693  1.00 30.28           C
ATOM    238  CZ  PHE A  52     -21.186   8.967  -2.591  1.00 34.39           C
ATOM    239  H   PHE A  52     -17.136   6.023  -3.953  0.00 31.54           H
ATOM    240  HA  PHE A  52     -16.252   8.296  -2.826  0.00 35.62           H
ATOM    241  HB2 PHE A  52     -17.618   6.104  -1.674  0.00 33.36           H
ATOM    242  HB3 PHE A  52     -17.168   7.374  -0.836  0.00 33.36           H
ATOM    243  HD1 PHE A  52     -19.436   6.359  -3.335  0.00 37.43           H
ATOM    244  HD2 PHE A  52     -18.520   9.318  -0.807  0.00 21.66           H
ATOM    245  HE1 PHE A  52     -21.447   7.385  -3.810  0.00 31.13           H
ATOM    246  HE2 PHE A  52     -20.527  10.346  -1.278  0.00 30.28           H
ATOM    247  HZ  PHE A  52     -21.996   9.382  -2.782  0.00 34.39           H
ATOM    248  N   THR A  53     -14.146   7.639  -1.733  1.00 33.07           N
ATOM    249  CA  THR A  53     -12.878   7.217  -1.153  1.00 37.39           C
ATOM    250  C   THR A  53     -12.805   7.699   0.287  1.00 37.53           C
ATOM    251  O   THR A  53     -13.102   8.863   0.569  1.00 36.82           O
ATOM    252  CB  THR A  53     -11.683   7.754  -1.947  1.00 30.49           C
ATOM    253  OG1 THR A  53     -11.727   9.186  -1.978  1.00 42.51           O
ATOM    254  CG2 THR A  53     -11.697   7.214  -3.369  1.00 32.39           C
ATOM    255  H   THR A  53     -14.262   8.491  -1.732  0.00 33.07           H
ATOM    256  HA  THR A  53     -12.832   6.248  -1.153  0.00 37.39           H
ATOM    257  HB  THR A  53     -10.860   7.468  -1.521  0.00 30.49           H
ATOM    258  HG1 THR A  53     -11.073   9.484  -2.413  0.00 42.51           H
ATOM    259 HG21 THR A  53     -10.937   7.560  -3.862  0.00 32.39           H
ATOM    260 HG22 THR A  53     -11.650   6.245  -3.356  0.00 32.39           H
ATOM    261 HG23 THR A  53     -12.513   7.484  -3.818  0.00 32.39           H
ATOM         HC  THR A  53     -12.515   7.072   1.010  1.00 37.53           H
TER
  ''',
  'cys_hg_capping' : '''
ATOM    660  N   CYS A  44     -13.948  11.544   0.019  1.00 43.55           N
ATOM    661  CA  CYS A  44     -13.878  12.244  -1.255  1.00 43.52           C
ATOM    662  C   CYS A  44     -14.755  11.508  -2.256  1.00 30.63           C
ATOM    663  O   CYS A  44     -14.828  10.276  -2.247  1.00 33.62           O
ATOM    664  CB  CYS A  44     -12.437  12.346  -1.775  1.00 42.78           C
ATOM    665  SG  CYS A  44     -12.212  13.498  -3.156  1.00 52.39           S
ATOM    666  H   CYS A  44     -14.083  10.698  -0.061  0.00 43.55           H
ATOM    667  HA  CYS A  44     -14.227  13.143  -1.147  0.00 43.52           H
ATOM    668  HB2 CYS A  44     -11.866  12.643  -1.049  0.00 42.78           H
ATOM    669  HB3 CYS A  44     -12.153  11.468  -2.075  0.00 42.78           H
ATOM    670  N   TYR A  45     -15.425  12.272  -3.116  1.00 37.87           N
ATOM    671  CA  TYR A  45     -16.349  11.715  -4.094  1.00 35.01           C
ATOM    672  C   TYR A  45     -16.036  12.276  -5.473  1.00 39.01           C
ATOM    673  O   TYR A  45     -15.818  13.482  -5.623  1.00 40.51           O
ATOM    674  CB  TYR A  45     -17.803  12.019  -3.718  1.00 31.40           C
ATOM    675  CG  TYR A  45     -18.805  11.563  -4.755  1.00 39.51           C
ATOM    676  CD1 TYR A  45     -19.028  10.211  -4.984  1.00 32.44           C
ATOM    677  CD2 TYR A  45     -19.523  12.482  -5.508  1.00 28.96           C
ATOM    678  CE1 TYR A  45     -19.939   9.788  -5.931  1.00 29.90           C
ATOM    679  CE2 TYR A  45     -20.436  12.069  -6.457  1.00 28.60           C
ATOM    680  CZ  TYR A  45     -20.640  10.721  -6.664  1.00 34.71           C
ATOM    681  OH  TYR A  45     -21.549  10.302  -7.609  1.00 35.76           O
ATOM    682  H   TYR A  45     -15.359  13.129  -3.151  0.00 37.87           H
ATOM    683  HA  TYR A  45     -16.239  10.752  -4.126  0.00 35.01           H
ATOM    684  HB2 TYR A  45     -18.012  11.568  -2.885  0.00 31.40           H
ATOM    685  HB3 TYR A  45     -17.904  12.977  -3.608  0.00 31.40           H
ATOM    686  HD1 TYR A  45     -18.556   9.580  -4.490  0.00 32.44           H
ATOM    687  HD2 TYR A  45     -19.387  13.392  -5.370  0.00 28.96           H
ATOM    688  HE1 TYR A  45     -20.079   8.880  -6.073  0.00 29.90           H
ATOM    689  HE2 TYR A  45     -20.911  12.696  -6.954  0.00 28.60           H
ATOM    690  HH  TYR A  45     -21.904  10.966  -7.981  0.00 35.76           H
ATOM    691  N   ASP A  46     -16.018  11.397  -6.473  1.00 29.94           N
ATOM    692  CA  ASP A  46     -15.796  11.772  -7.866  1.00 32.85           C
ATOM    693  C   ASP A  46     -17.051  11.409  -8.649  1.00 31.89           C
ATOM    694  O   ASP A  46     -17.367  10.225  -8.807  1.00 36.43           O
ATOM    695  CB  ASP A  46     -14.564  11.067  -8.434  1.00 33.02           C
ATOM    696  CG  ASP A  46     -14.084  11.681  -9.738  1.00 40.82           C
ATOM    697  OD1 ASP A  46     -14.799  12.536 -10.301  1.00 36.55           O
ATOM    698  OD2 ASP A  46     -12.986  11.303 -10.200  1.00 39.31           O
ATOM    699  H   ASP A  46     -16.136  10.552  -6.364  0.00 29.94           H
ATOM    700  HA  ASP A  46     -15.659  12.730  -7.927  0.00 32.85           H
ATOM    701  HB2 ASP A  46     -13.841  11.127  -7.790  0.00 33.02           H
ATOM    702  HB3 ASP A  46     -14.782  10.137  -8.603  0.00 33.02           H
  ''',
  'fva' : '''
CRYST1  100.846  117.207  186.414  90.00  90.00  90.00 P 1
SCALE1      0.009916  0.000000  0.000000        0.00000
SCALE2      0.000000  0.008532  0.000000        0.00000
SCALE3      0.000000  0.000000  0.005364        0.00000
HETATM    1  N   FVA A   1       6.169   3.899  16.827  1.00 11.30           N
HETATM    2  CA  FVA A   1       7.258   4.020  15.893  1.00  9.02           C
HETATM    3  C   FVA A   1       8.123   2.761  15.952  1.00 12.34           C
HETATM    4  O   FVA A   1       8.432   2.185  17.000  1.00 15.44           O
HETATM    5  CN  FVA A   1       4.866   4.251  16.548  1.00 16.52           C
HETATM    6  O1  FVA A   1       4.490   4.713  15.459  1.00 19.98           O
HETATM    7  H   FVA A   1       6.367   3.584  17.602  0.00 11.30           H
HETATM    8  HN  FVA A   1       4.261   4.091  17.289  0.00 16.52           H
HETATM    9  CB AFVA A   1       8.153   5.260  16.162  0.72 14.88           C
HETATM   10  CG1AFVA A   1       9.025   5.015  17.376  0.72 16.40           C
HETATM   11  CG2AFVA A   1       9.019   5.589  14.965  0.72 18.48           C
HETATM   12  HA AFVA A   1       6.897   4.095  14.996  0.00  9.02           H
HETATM   13  HB AFVA A   1       7.573   6.016  16.344  0.00 14.95           H
HETATM   14 HG11AFVA A   1       9.312   5.856  17.764  0.00 18.82           H
HETATM   15 HG12AFVA A   1       9.813   4.510  17.123  0.00 18.82           H
HETATM   16 HG13AFVA A   1       8.541   4.518  18.054  0.00 18.82           H
HETATM   17 HG21AFVA A   1       9.632   6.311  15.176  0.00 23.20           H
HETATM   18 HG22AFVA A   1       8.478   5.857  14.205  0.00 23.20           H
HETATM   19 HG23AFVA A   1       9.538   4.811  14.708  0.00 23.20           H
ATOM     20  N   GLY A   2       8.526   2.318  14.765  1.00  9.14           N
ATOM     21  CA  GLY A   2       9.367   1.142  14.630  1.00  9.18           C
ATOM     22  C   GLY A   2       8.922   0.225  13.508  1.00 13.11           C
ATOM     23  O   GLY A   2       8.413   0.681  12.484  1.00 17.27           O
ATOM     24  H   GLY A   2       8.322   2.688  14.016  0.00  9.14           H
ATOM     25  HA2 GLY A   2      10.280   1.419  14.454  0.00  9.18           H
ATOM     26  HA3 GLY A   2       9.356   0.636  15.457  0.00  9.18           H
ATOM     27  N   ALA A   3       9.116  -1.075  13.703  1.00  9.39           N
ATOM     28  CA  ALA A   3       8.738  -2.068  12.704  1.00  8.93           C
ATOM     29  C   ALA A   3       7.287  -2.497  12.896  1.00 15.88           C
ATOM     30  O   ALA A   3       6.570  -1.940  13.728  1.00 14.37           O
ATOM     31  CB  ALA A   3       9.664  -3.273  12.779  1.00 13.63           C
ATOM     32  H   ALA A   3       9.468  -1.411  14.413  0.00  9.39           H
ATOM     33  HA  ALA A   3       8.823  -1.678  11.820  0.00  8.93           H
ATOM     34  HB1 ALA A   3       9.418  -3.906  12.087  0.00 13.63           H
ATOM     35  HB2 ALA A   3      10.578  -2.976  12.646  0.00 13.63           H
ATOM     36  HB3 ALA A   3       9.575  -3.685  13.653  0.00 13.63           H
HETATM   37  N   DLE A   4       6.859  -3.489  12.121  1.00  9.50           N
HETATM   38  CA  DLE A   4       5.494  -3.993  12.202  1.00 10.70           C
HETATM   39  C   DLE A   4       4.592  -3.260  11.215  1.00 14.72           C
HETATM   40  O   DLE A   4       5.072  -2.581  10.307  1.00 14.32           O
HETATM   41  CB  DLE A   4       5.464  -5.496  11.915  1.00 15.03           C
HETATM   42  CG  DLE A   4       6.263  -6.378  12.877  1.00 25.23           C
HETATM   43  CD1 DLE A   4       5.684  -6.310  14.283  1.00 29.22           C
HETATM   44  CD2 DLE A   4       6.299  -7.815  12.380  1.00 38.38           C
ATOM         OXT DLE A   4       3.368  -3.343  11.321  1.00 14.72           O
ATOM     45  H   DLE A   4       7.345  -3.890  11.536  0.00  9.50           H
HETATM   46  HA  DLE A   4       5.148  -3.845  13.096  0.00 10.70           H
HETATM   47  HB2 DLE A   4       5.819  -5.644  11.025  0.00 15.03           H
HETATM   48  HB3 DLE A   4       4.542  -5.794  11.947  0.00 15.03           H
HETATM   49  HG  DLE A   4       7.176  -6.054  12.915  0.00 25.23           H
HETATM   50 HD11 DLE A   4       6.163  -6.933  14.851  0.00 29.22           H
HETATM   51 HD12 DLE A   4       4.744  -6.549  14.248  0.00 29.22           H
HETATM   52 HD13 DLE A   4       5.784  -5.407  14.622  0.00 29.22           H
HETATM   53 HD21 DLE A   4       6.806  -8.354  13.008  0.00 38.38           H
HETATM   54 HD22 DLE A   4       6.724  -7.836  11.508  0.00 38.38           H
HETATM   55 HD23 DLE A   4       5.391  -8.150  12.314  0.00 38.38           H

  ''',
        }

def test_qxyz_non_zero():
  def _check_non_zero_charge(filename):
    for line in open(filename, 'rb').readlines():
      tmp = line.split()
      if len(tmp)<2: continue
      assert float(tmp[0])!=0, 'no partial charge %s' % line
  for residue in ['pro',
                  'gly',
                  ]:
    tf='%s.pdb' % residue
    f=file(tf, "wb")
    f.write(pdbs[residue])
    f.close()
    pdb_inp = pdb.input(tf)
    hierarchy = pdb_inp.construct_hierarchy()
    charges.write_pdb_hierarchy_qxyz_file(hierarchy,
                                               'test_%s.dat' % residue,
                                             )
    _check_non_zero_charge('test_%s.dat' % residue)

def test_qxyz_xyzq():
  tf='water.pdb'
  f=file(tf, "wb")
  f.write(pdbs["water"])
  f.close()
  pdb_inp = pdb.input(tf)
  hierarchy = pdb_inp.construct_hierarchy()
  if  os.path.exists('test_water.dat'): os.remove('test_water.dat')
  charges.write_pdb_hierarchy_qxyz_file(hierarchy,
                                             'test_water.dat',
                                             )
  assert not os.path.exists('test_water.dat')
  charges.write_pdb_hierarchy_qxyz_file(hierarchy,
                                             'test_water.dat',
                                             exclude_water=False,
                                             )
  tst_str = '''\
3

-0.408  -0.21  0.0  -0.296
0.204  0.733  0.0  -0.296
0.204  -0.524  0.0  0.593
'''
  lines = open('test_water.dat', 'rb').read()
  lines = lines.strip().replace('\n','').replace(' ','')
  tst_str = tst_str.strip().replace('\n','').replace(' ','')
  #for a,b in zip(lines.strip(), tst_str.strip()): print '"%s" "%s"' % (a,b)
  assert lines.strip()==tst_str.strip(), '"%s"\n"%s"' % (tst_str.strip(),
                                                         lines.strip())
  os.remove('test_water.dat')
  charges.write_pdb_hierarchy_xyzq_file(hierarchy,
                                        'test_water.dat',
                                        exclude_water=False,
                                      )
  tst_str = '''\
-0.21  0.0  -0.296  -0.408
0.733  0.0  -0.296  0.204
-0.524  0.0  0.593  0.204'''
  lines = open('test_water.dat', 'rb').read()
  lines = lines.strip().replace('\n','').replace(' ','')
  tst_str = tst_str.strip().replace('\n','').replace(' ','')
  assert lines.strip()==tst_str, '%s'% (lines)
  os.remove('test_water.dat')

def test_terminal_and_alt_loc(residue):
  tf = '%s_terminal.pdb' % residue
  f=file(tf, "wb")
  f.write(pdbs["%s_terminal" % residue])
  f.close()
  assert  qr_repo_parent, 'Set environmental variable %s' % qr_repo_parent_env
  cmd = 'iotbx.python %s/qr-core/finalise.py %s' % (qr_repo_parent, tf)
  print cmd
  easy_run.call(cmd)
  pdb_inp = pdb.input(tf.replace('.pdb', '_complete.pdb'))
  hierarchy = pdb_inp.construct_hierarchy()
  must_find = ['H2', 'H3', 'OXT']
  if residue!='PRO': must_find.append('H1')
  for atom in hierarchy.atoms():
    if residue=='PRO': assert atom.name.strip()!='H1'
    if atom.name.strip() in must_find:
      must_find.remove(atom.name.strip())
  assert not must_find, 'must find %s is not empty' % must_find

def test_PRO_terminal_and_alt_loc():
  test_terminal_and_alt_loc('PRO')

def test_GLY_terminal_and_alt_loc():
  test_terminal_and_alt_loc('GLY')

def test_1yjp_charge():
  assert  qr_repo_parent, 'Set environmental variable %s' % qr_repo_parent_env
  tf='%s/qr-core/tests/data_files/1yjp.pdb' % qr_repo_parent
  try: os.symlink(tf, os.path.basename(tf))
  except: pass
  tf = os.path.basename(tf)
  pdb_inp = pdb.input(tf)
  hierarchy = pdb_inp.construct_hierarchy()
  try:
    charge = charges.calculate_pdb_hierarchy_charge(hierarchy)
    assert 0
  except Exception, e:
    assert e.message.find('no hydrogens')>-1
  cmd = 'iotbx.python %s/qr-core/finalise.py %s' % (qr_repo_parent, tf)
  easy_run.call(cmd)
  pdb_inp = pdb.input(tf.replace('.pdb', '_complete.pdb'))
  hierarchy = pdb_inp.construct_hierarchy()
  charge = charges.calculate_pdb_hierarchy_charge(hierarchy, verbose=False)
  assert charge==0, 'charge of 1yjp should be zero not %s' % charge

def test_terminal_charge(residue, charge=0):
  # must run after other PRO
  tf = '%s_terminal_complete.pdb' % residue
  ppf = hierarchy_utils .get_processed_pdb(pdb_filename=tf)
  inter_residue_bonds = charges.get_inter_residue_bonds(ppf)
  # should the hierarchy come from ppf???
  pdb_inp = iotbx.pdb.input(tf)
  hierarchy = pdb_inp.construct_hierarchy()
  hetero_charges = charges.get_hetero_charges(pdb_inp, hierarchy)
  if not hetero_charges:
    # some defaults
    hetero_charges = charges.default_ion_charges
  total_charge = charges.calculate_pdb_hierarchy_charge(
    hierarchy,
    hetero_charges=hetero_charges,
    inter_residue_bonds=inter_residue_bonds,
    verbose=False,
  )
  assert total_charge==charge, "total_charge: %d, charge:%d"%(total_charge,charge)

def test_PRO_terminal_charge():
  test_terminal_charge('PRO')

def test_GLY_terminal_charge():
  test_terminal_charge('GLY')

def test_capping_of_C_terminal():
  tf = 'c_terminal_capping.pdb'
  f=file(tf,'wb')
  f.write(pdbs['c_terminal_capping'])
  f.close()
  cmd = 'iotbx.python %s model_completion=False %s' % (
    os.path.join(qrefine_d, 'finalise.py'),
    tf,
    )
  print cmd
  easy_run.call(cmd)
  pdb_inp = pdb.input(tf.replace('.pdb', '_capping.pdb'))
  hierarchy = pdb_inp.construct_hierarchy()
  must_find = ['OXT']
  for atom in hierarchy.atoms():
    if atom.name.strip() in must_find:
      must_find.remove(atom.name.strip())
  assert not must_find

def test_helix():
  tf = 'helix.pdb'
  f=file(tf, "wb")
  f.write(pdbs["helix"])
  f.close()
  pdb_inp=pdb.input(tf)
  hierarchy = pdb_inp.construct_hierarchy()
  charge = qrefine.charges.calculate_pdb_hierarchy_charge(hierarchy,
                                                          verbose=False)
  assert charge==0, 'charge of helix should be zero not %s' % charge
  cmd = 'iotbx.python %s %s' % (
    os.path.join(qrefine_d, 'completion.py'),
    tf)
  cmd += ' append_to_end_of_model=0'
  print cmd
  easy_run.call(cmd)
  pdb_inp = pdb.input(tf.replace('.pdb', '_complete.pdb'))
  hierarchy = pdb_inp.construct_hierarchy()
  must_find = ['H1', 'H2', 'H3', 'OXT']
  for atom in hierarchy.atoms():
    if atom.name.strip() in must_find:
      must_find.remove(atom.name.strip())
  assert not must_find
  pdb_inp=pdb.input(tf.replace('.pdb', '_complete.pdb'))
  hierarchy = pdb_inp.construct_hierarchy()
  charge = qrefine.charges.calculate_pdb_hierarchy_charge(hierarchy,
                                                          verbose=False)
  assert charge==1, 'charge of helix should be one not %s' % charge

def test_charge_for_charmm_pdbs(only_i=None):
  from charges import calculate_pdb_hierarchy_charge
  charge_dict = {'3kyi': -12,
                 '2oy0': 16,
                 '1y1l': -8,
                 '3dtj': 0,
                 '3tz9': -10,
                 '4rnf': -13,
                 '2jee': -32,
                 '4k2r': -1,
                 '5d12': -11,
                 '1il5': 0,
                 '1va7': -8,
                 '2oeq': -5,
                 '4drw': -16,
                 '4xa1': -45,
                 '2ghj': 46,
                 '1ok9': -14,
                 '3nak': 0,
                 '2x10': -22,
                 '3oe9': 27,
                 '4fsx': -42,
                 '4p7h': -19,
                 '5diz': -25,
                 '3uds': -8,
                 '3uj4': 0,
                 '4ctd': -44,
                 '1byz': -4,
                 '1lzt': 8,
                 '1vfy': -1,
                 '1m24': -2,
                 '1i07': 4,
                 '1opd': -6,
                 '1vbw': 8,
                 '1rfs': -4,
                 '1ly2': 7,
                 '1a7y': 0,
                 '1v7s': 8,
                 '2wpz': 0,
                 '2akf': -3,
                 '4lzt': 8,
                 '3ovj': 4,
                 '4lzl': -5,
                 '4w71': 0,
                 '4uiv': 4,
                 '4rp6': -1,
                 '3u29': 0,
                 '2omq': -4,
                 '2ol9': 0,
                 '4xfo': 0,
                 '2xmu': -10,
                 '2xmt': -10,
                 '4uit': 4,
                 '4uiu': 4,
                 '4onk': 0,
                 '2f2n': 8,
                 '4uiw': 4,
                 '5cgo': 6,
                 '2y3j': 0,
                 '2i1u': -1,
                 '4w67': 0,
                 '3osm': 9,
                 '4wxt': -4,
                 '3o2h': -1,
                 '2f30': 8,
                 '4w5y': 0,
                 '5e5v': 0,
                 '2ona': 0,
                 '4itk': -9,
                 '5e61': 0,
                 '4kdw': -17,
                 '4z0w': -2,
                 '4uby': 0,
                 '2w9r': -1,
                 '3t4f': 0,
                 '3pzz': 0,
                 '2y3k': 0}
  assert  qr_repo_parent, 'Set environmental variable %s' % qr_repo_parent_env
  pdb_dir = '%s/qr-core/tests/charmm_pdbs' % qr_repo_parent
  pdb_files = os.listdir(pdb_dir)
  for i, pdb_file in enumerate(pdb_files):
    if only_i is not None and i!=only_i: continue
    if pdb_file[:-4] not in charge_dict: continue
    if pdb_file.endswith(".pdb"):
      if pdb_file in ['2i1u.pdb',
                      '4wxt.pdb',
      ]:
        # disuphide bridge = in 2i1u 2.94 Phenix says yes, Charmm says no
        continue
      pdb_file_path = os.path.join(pdb_dir, pdb_file)
      print 'pdb_file_path',pdb_file_path
      charge = charges.get_total_charge_from_pdb(pdb_file_path)
      assert charge==charge_dict[pdb_file[:-4]], \
        '%s charge is %d, charmm charge is %d,  no matchy matchy' % (
          pdb_file[:-4],
          charge,
          charge_dict[pdb_file[:-4]],
        )

def test_charge_of_neutral_terminal():
  assert  qr_repo_parent, 'Set environmental variable %s' % qr_repo_parent_env
  charge = 0
  tf = "%s/qr-core/tests/babel_pdbs/clusters/neutral_nterminal.pdb" % qr_repo_parent
  charge_neutral_nterminal = charges.get_total_charge_from_pdb(tf)
  assert charge == charge_neutral_nterminal, 'no match %s %s' % (
    charge,
    charge_neutral_nterminal,
    )
  tf = "%s/qr-core/tests/babel_pdbs/clusters/neutral_cterminal.pdb" % qr_repo_parent
  charge_neutral_cterminal = charges.get_total_charge_from_pdb(tf)
  assert charge == charge_neutral_cterminal, 'no match %s %s' % (
    charge,
    charge_neutral_cterminal,
    )

def test_capping_of_cluster_complete(only_i=None):
  assert  qr_repo_parent, 'Set environmental variable %s' % qr_repo_parent_env
  pdb_dir = '%s/qr-core/tests/babel_pdbs' % qr_repo_parent
  babel_dir = os.path.join(pdb_dir, 'capping')
  cluster_dir = os.path.join(pdb_dir, 'clusters')
  cluster_files = os.listdir(cluster_dir)
  for i, cluster_file in enumerate(cluster_files):
    if only_i is not None and i!=only_i: continue
    if cluster_file.find('capping')>-1: continue
    if cluster_file.endswith(".pdb") and ("temp" not in cluster_file):
      cluster_file_path = os.path.join(cluster_dir, cluster_file)
      if not os.path.exists(cluster_file):
        os.symlink(cluster_file_path, cluster_file)
      cluster_file_path = cluster_file
      cmd = "phenix.python %s/qr-core/completion.py %s model_completion=False" % (
        qr_repo_parent,
        cluster_file_path,
        )
      print cmd
      easy_run.call(cmd)
      result_file = cluster_file_path[:-4] + "_capping.pdb"
      babel_file = os.path.join(babel_dir, cluster_file[:-4] + "_babel.pdb")
      result_size = len(pdb.input(result_file).atoms())
      babel_size =  len(pdb.input(babel_file).atoms())
      print babel_file,babel_size,result_file,result_size
      assert result_size ==  babel_size,\
        '%s atom size after babel capping: %d, after run_cluster_complete: %d' %(cluster_file, babel_size, result_size)

def test_short_gap():
  f=file('test_short_gap.pdb', 'wb')
  f.write(pdbs['short_gap'])
  f.close()
  cmd = "phenix.python %s %s model_completion=False" % (
    os.path.join(qrefine_d, 'completion.py'),
    'test_short_gap.pdb',
  )
  print cmd
  easy_run.call(cmd)
  result_file = "test_short_gap_capping.pdb"
  result_size = len(pdb.input(result_file).atoms())
  print result_file
  assert result_size==28

def test_original_pdb():
  f=file('test_original_pdb.pdb', 'wb')
  f.write(pdbs['2ona_short'])
  f.close()
  cmd = 'phenix.python %s %s %s %s' % (
    os.path.join(qrefine_d, 'completion.py'),
    'test_original_pdb.pdb',
    'model_completion=0',
    'original_pdb_filename=%s' % os.path.join(qrefine_d,
                                              'tests',
                                              'unit',
                                              'charmm_pdbs',
                                              '2ona.pdb')
    )
  print cmd
  rc = easy_run.go(cmd)
  pdb_inp = pdb.input('test_original_pdb.pdb')
  assert len(pdb_inp.atoms())==49
  pdb_inp = pdb.input('test_original_pdb_capping.pdb')
  assert len(pdb_inp.atoms())==50

def test_10_capping():
  f=file('test_10_capping.pdb', 'wb')
  f.write(pdbs['10_capping'])
  f.close()
  from qrefine import charges
  cc = charges.charges_class('test_10_capping.pdb')
  rc = cc.get_total_charge(list_charges=True)
  for test_charge, calculated_charge in zip([0,1,0,0,0,0,-1,0,0,0,0,1,0,0,0,1],
                                            rc,
                                            ):
    assert test_charge==calculated_charge[1], 'Charge %s not %s' % (
      test_charge,
      calculated_charge,
      )

def _run_go_cmd_on_pdb(code, cmd):
  f=file('test_%s.pdb' % code, 'wb')
  f.write(pdbs[code])
  f.close()
  cmd += ' %s' % ('test_%s.pdb' % code)
  print '  ~> %s' % cmd
  rc = easy_run.go(cmd)
  return rc
  
def test_cys_hg_capping():
  rc = _run_go_cmd_on_pdb('cys_hg_capping', 'qr.finalise action=capping')
  assert rc.return_code==0, rc.show_stdout()

def test_fva():
  rc = _run_go_cmd_on_pdb('fva', 'qr.charges')
  assert rc.return_code==0, rc.show_stdout()
  assert 0

def run(prefix = "tst_12", nproc=1):
  """
  Exercise structure preparation including charge, capping, completion
  """
  tests = [
    #[test_fva, 1],
    [test_original_pdb, 1],
    [test_short_gap, 1],
    [test_helix, 1],
    [test_capping_of_C_terminal, 1],
    [test_10_capping, 1],
    [test_cys_hg_capping, 1],
  ]
  junk = [
    [test_GLY_terminal_and_alt_loc, 1],
    [test_PRO_terminal_and_alt_loc, 1],
    [test_charge_of_neutral_terminal, 1],
    [test_qxyz_non_zero, 1],
    [test_qxyz_xyzq, 1],
    [test_1yjp_charge, 1],
    [test_charge_for_charmm_pdbs, 80],
    [test_capping_of_cluster_complete, 65],
    # need files from alt loc test
    [test_GLY_terminal_charge, 1],
    [test_PRO_terminal_charge, 1],
    ]
  if 0:
    tests = [
      [test_capping_of_C_terminal, 1],
      ]
  def get_test(i, j):
    func = tests[i][0]
    if j is not None: return func(j)
    else: return func()
  ####
  argss = []
  for i, (func, j) in enumerate(tests):
    if j==1: argss.append((i,None))
    else:
      j = min(1,j)
      for p in range(j):
        if (i,p) in [(10,60)]: continue # capping and completion of PRO
        argss.append((i,p))
  passed=0
  failed=0
  for args, res, errstr in easy_mp.multi_core_run(get_test, argss, nproc):
    if errstr:
      print '-'*80
      print args
      print 'RESULT - ERROR   : %s %s' % (tests[args[0]][0].func_name, args)
      print errstr
      print '-'*80
      failed+=1
    else:
      print 'RESULT - SUCCESS : %s %s' % (tests[args[0]][0].func_name, args)
      passed+=1
  print '\n\tpassed : %d\n\tfailed : %s' % (passed, failed)
  if failed: return -1
  return 0

if(__name__ == "__main__"):
  t0 = time.time()
  prefix = "tst_12"
  if(1):
    rc = run(prefix)
    assert rc==0
    print prefix + ":  OK  " + "Time: %6.2f (s)" % (time.time() - t0)
  else:
    print prefix + ":  Skipped    "
  run_tests.clean_up(prefix)
