# Basic Mamba CI pipeline on top of CCTBX

name: CI pipeline on Mamba

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  MOPAC_COMMAND: /home/runner/micromamba/envs/qrefine-ci-mamba/bin/mopac
  XTBHOME: /home/runner/micromamba/envs/qrefine-ci-mamba

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}

    steps:


    - name: checkout code
      uses: actions/checkout@v3

      
    - uses: mamba-org/setup-micromamba@v1
      with:
        environment-file: environment.yaml      
        cache-environment: true
        use-only-tar-bz2: true 
        activate-environment: qrefine-ci-mamba

    - run: |
         pwd
         cd /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages
         mkdir chem_data 
         cd chem_data 
         svn --quiet --non-interactive --trust-server-cert co svn://svn.code.sf.net/p/geostd/code/trunk geostd 
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/mon_lib.git/trunk mon_lib 
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/reference_data.git/trunk/Top8000/Top8000_rotamer_pct_contour_grids rotarama_data
         rm -rf rotarama_data/.svn
         svn --quiet --non-interactive --trust-server-cert --force co https://github.com/rlabduke/reference_data.git/trunk/Top8000/Top8000_ramachandran_pct_contour_grids rotarama_data 
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/reference_data.git/trunk/Top8000/Top8000_cablam_pct_contour_grids cablam_data 
         cd ..
         mkdir modules
         cd /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/probe.git/trunk probe
         cd probe 
         make 
         cp hybrid_36_c.c /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/iotbx/pdb/hybrid_36_c.c
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/reduce.git/trunk reduce
         cd reduce 
         make
        
    - name: copy qreinfe code
      run: | 
       cd 
       cp -r /home/runner/work/qrefine/qrefine /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules/qrefine
       ls /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules/qrefine
       
    - run: rm -rf /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules/qrefine/plugin/yoink

    #- name: activate enviroment
    #  run: micromamba activate qrefine-ci-mamba

    - run: |
        cd /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages
        mkdir build 
        cd build 
        mkdir -p probe/exe/
        cp -r /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules/probe/probe probe/exe/ 



        # Pull in latest code from mmtbx:
        #cd /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/mmtbx
        cd /home/runner/work/qrefine/qrefine 
        curl -LO https://github.com/cctbx/cctbx_project/archive/refs/heads/master.zip
        unzip master.zip
        cp -r /home/runner/work/qrefine/qrefine/cctbx_project-master/mmtbx /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/mmtbx
        
        libtbx.configure probe 
        libtbx.configure qrefine 
        libtbx.configure reduce 
        mmtbx.rebuild_rotarama_cache
        mmtbx.rebuild_cablam_cache
    
    - name: smoke test
      run: |
        source /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/build/setpaths.sh
        qr.refine --help
    - name: qr.test
      run: |
        source /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/build/setpaths.sh
        qr.test > qr_test.txt
    - name: Archive qr test output
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: qr-test-output
        path: qr_test.txt



    
