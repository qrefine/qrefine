# Basic Mamba CI pipeline on top of CCTBX

name: CI pipeline on Mamba

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  MOPAC_COMMAND: /home/runner/micromamba/envs/qrefine-ci-mamba/bin/mopac
  XTBHOME: /home/runner/micromamba/envs/qrefine-ci-mamba
  #CLEANUP_TESTS: 'FALSE'

permissions:
  contents:  read

jobs:
  build:

    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}

    steps:


    - name: checkout code
      uses: actions/checkout@v3

      
    - uses: mamba-org/setup-micromamba@v1
      with:
        environment-file: environment.yaml      
        cache-environment: true
        use-only-tar-bz2: true 
        activate-environment: qrefine-ci-mamba

    - name:  build chem_data, probe, and reduce
      run: |
         pwd
         cd /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages
         mkdir chem_data 
         cd chem_data 
         svn --quiet --non-interactive --trust-server-cert co svn://svn.code.sf.net/p/geostd/code/trunk geostd 
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/mon_lib.git/trunk mon_lib 
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/reference_data.git/trunk/Top8000/Top8000_rotamer_pct_contour_grids rotarama_data
         rm -rf rotarama_data/.svn
         svn --quiet --non-interactive --trust-server-cert --force co https://github.com/rlabduke/reference_data.git/trunk/Top8000/Top8000_ramachandran_pct_contour_grids rotarama_data 
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/reference_data.git/trunk/Top8000/Top8000_cablam_pct_contour_grids cablam_data 
         cd ..
         mkdir modules
         cd /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/probe.git/trunk probe
         cd probe 
         make 
         cp hybrid_36_c.c /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/iotbx/pdb/hybrid_36_c.c
         cd ..
         svn --quiet --non-interactive --trust-server-cert co https://github.com/rlabduke/reduce.git/trunk reduce
         cd reduce 
         make
        
    - name: copy qrefine code to modules dir.
      run: | 
       cd 
       cp -r /home/runner/work/qrefine/qrefine /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules/qrefine
       #ls /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules/qrefine
       
    - name: delete old yoink code
      run: rm -rf /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules/qrefine/plugin/yoink

    #- name: activate enviroment
    #  run: micromamba activate qrefine-ci-mamba

    - name: build probe
      working-directory: /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages
      run: |
        mkdir build 
        cd build 
        mkdir -p probe/exe/
        cp -r /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules/probe/probe probe/exe/ 

    - name: update to latest cctbx-nightly
      run: |

        # Pull in latest code from mmtbx:
        #cd /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/mmtbx
        #cd /home/runner/work/qrefine/qrefine 
        #curl -LO https://github.com/cctbx/cctbx_project/archive/refs/heads/master.zip
        #unzip master.zip
        #rm -rf /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/mmtbx
        #cp -r /home/runner/work/qrefine/qrefine/cctbx_project-master/mmtbx /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/mmtbx
        
        conda update cctbx -c cctbx-nightly

    - name: configure  modules  
      working-directory: /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/build
      run: |     
        libtbx.configure mmtbx
        libtbx.configure probe 
        libtbx.configure qrefine 
        libtbx.configure reduce 
        mmtbx.rebuild_rotarama_cache
        mmtbx.rebuild_cablam_cache
    
    - name: smoke test
      run: |
        source /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/build/setpaths.sh
        qr.refine --help
        
    - name: qr.test
      run: |
        cd /home/runner/work/qrefine/qrefine/
        mkdir testing_workdir
        cd testing_workdir
        source /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/build/setpaths.sh        
        python /home/runner/micromamba/envs/qrefine-ci-mamba/lib/python3.10/site-packages/modules/qrefine/tests/unit/tst_01.py > ../qr_test.txt
        #qr.test > ../qr_test.txt
    
    - name: looks at testing_workdir
      if: always()
      run: ls -R
      working-directory: ./testing_workdir
        
    - name: Archive qr test output
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: qr-test-output
        path: ./qr_test.txt

    - name: Archive qr-log files output
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: tests-dir
        path: ./testing_workdir

    - name: Report Status
      if: always()
      uses: ravsamhq/notify-slack-action@v2
      with:
        status: ${{ job.status }}
        notify_when: 'failure'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.ACTION_MONITORING_SLACK }}     
        



    
